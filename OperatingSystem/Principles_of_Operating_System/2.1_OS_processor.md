# 处理器状态(模式)

1 操作系统运行环境

* CPU状态
* 中断/异常机制

2 操作系统运行机制

* 系统调用

## 1 CPU 中央处理器

### 1.1 组成
CPU 由运算器、控制器、一系列寄存器 以及 高速缓存 构成
其中，
两类寄存器

* 用户可见寄存器：高级语言编译器通过优化算法分配并使用，以减少程序访问内存次数
* 控制和状态寄存器：用于控制处理器的操作
    常见的控制和状态寄存器：
       
        * PC:Program Counter - 记录指令地址
        * IR:Instruction Register - 记录最近取出的指令
        * PSW:Program Status Word - 记录处理器的运行状态(条件码、模式、控制位等)

Question: 处理器 基本运行机制？

1. 处理器具有特权级别 - 能在不同的特权级 运行不同 指令集合
2. 硬件机制可将 OS 与 用户程序 隔离


### 1.2 处理器的状态
现代处理器 通常将CPU状态 设计 分为 2/3/4 种，
在PSW中专门设置一位，根据运行程序 **对资源和指令的使用权限**设置不同的CPU状态

操作系统需要两种CPU状态：

* 内核态(Kernel Mode) - 运行操作系统程序
* 用户态(User Mode) - 运行用户程序

实例： X86系列处理器 支持4个处理器特权级别 - R0 / R1 / R2 / R3
    
    * 从R0到R3，特权能力由高到低
    * R0 相当于内核态 <supervisor mode>
    * R3 相当于用户态
    * 不同级别能够运行的指令集合不同

问题：CPU状态之间的转换

* 用户态 -> 内核态
    * 唯一途径 -- 中断/异常/陷入机制
* 内核态 -> 用户态
    * 设置程序状态字PSW

陷入指令（访管指令）：提供给用户程序的接口，用于调用操作系统的功能（服务）
例如：int,trap,syscall,sysenter/sysexit


